name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Generate file list for ESA preheat
        id: file-list
        run: |
          # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
          cd build
          find . -type f | sed 's|^\./||' > ../file-list.txt
          cd ..
          echo "Generated $(wc -l < file-list.txt) files"
          # ä¿å­˜æ–‡ä»¶æ•°é‡åˆ°è¾“å‡º
          echo "file_count=$(wc -l < file-list.txt)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        id: dockerhub-login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to Aliyun Container Registry
        id: aliyun-login
        uses: docker/login-action@v2
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_CR_USERNAME }}
          password: ${{ secrets.ALIYUN_CR_PASSWORD }}

      - name: Build and Push Docker Image
        id: docker-build
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            registry.cn-hangzhou.aliyuncs.com/passnat/docs:${{ github.sha }}
            registry.cn-hangzhou.aliyuncs.com/passnat/docs:latest

      - name: Trigger Deploy Webhook
        id: deploy-webhook
        run: |
          curl -f -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}/v1/update" \
            -H "Authorization: Bearer ${{ secrets.DEPLOY_WEBHOOK_TOKEN }}"
          echo "Deploy webhook triggered!"

      - name: Setup Aliyun CLI
        run: |
          /bin/bash -c "$(curl -fsSL https://aliyuncli.alicdn.com/install.sh)"
          aliyun configure set \
            --profile AkProfile \
            --mode AK \
            --access-key-id ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
            --access-key-secret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }} \
            --region cn-hangzhou

      - name: Refresh ESA CDN Cache
        id: esa-refresh
        continue-on-error: true
        run: |
          aliyun esa PurgeCaches \
            --region cn-hangzhou \
            --Content '{"CacheKeys":[{}],"Hostnames":["doc.passnat.com"]}' \
            --SiteId ${{ secrets.ALIYUN_ESA_SITE_ID }} \
            --Type hostname
          echo "ESA CDN cache refreshed!"

      - name: Preheat ESA CDN Cache
        id: esa-preheat
        continue-on-error: true
        run: |
          HOSTNAME="doc.passnat.com"
          SITE_ID="${{ secrets.ALIYUN_ESA_SITE_ID }}"

          # è¯»å–æ–‡ä»¶åˆ—è¡¨å¹¶ç”Ÿæˆ URL æ•°ç»„
          URLS=""
          while IFS= read -r file; do
            if [ -n "$URLS" ]; then
              URLS="$URLS,\"https://$HOSTNAME/$file\""
            else
              URLS="\"https://$HOSTNAME/$file\""
            fi
          done < file-list.txt

          # ESA é¢„çƒ­æœ‰æ•°é‡é™åˆ¶ï¼Œåˆ†æ‰¹å¤„ç†ï¼ˆæ¯æ‰¹æœ€å¤š 100 ä¸ªï¼‰
          BATCH_SIZE=100
          TOTAL=$(wc -l < file-list.txt)
          BATCHES=$(( (TOTAL + BATCH_SIZE - 1) / BATCH_SIZE ))

          echo "Total files: $TOTAL, Batches: $BATCHES"

          SUCCESS=0
          FAILED=0

          for i in $(seq 0 $((BATCHES - 1))); do
            START=$((i * BATCH_SIZE + 1))
            END=$(((i + 1) * BATCH_SIZE))

            # æå–å½“å‰æ‰¹æ¬¡çš„æ–‡ä»¶
            BATCH_URLS=""
            sed -n "${START},${END}p" file-list.txt | while IFS= read -r file; do
              if [ -n "$BATCH_URLS" ]; then
                BATCH_URLS="$BATCH_URLS,\"https://$HOSTNAME/$file\""
              else
                BATCH_URLS="\"https://$HOSTNAME/$file\""
              fi
              echo "$BATCH_URLS" > /tmp/batch_urls.txt
            done

            BATCH_URLS=$(cat /tmp/batch_urls.txt 2>/dev/null || echo "")

            if [ -n "$BATCH_URLS" ]; then
              echo "Preheating batch $((i + 1))/$BATCHES..."
              if aliyun esa PreloadCaches \
                --region cn-hangzhou \
                --SiteId $SITE_ID \
                --Content "[$BATCH_URLS]"; then
                SUCCESS=$((SUCCESS + 1))
              else
                FAILED=$((FAILED + 1))
              fi
            fi
          done

          echo "Preheat completed: $SUCCESS batches succeeded, $FAILED batches failed"
          echo "success_batches=$SUCCESS" >> $GITHUB_OUTPUT
          echo "failed_batches=$FAILED" >> $GITHUB_OUTPUT

      - name: Send Success Notification to Feishu
        if: success()
        run: |
          ESA_REFRESH_STATUS="${{ steps.esa-refresh.outcome }}"
          ESA_PREHEAT_STATUS="${{ steps.esa-preheat.outcome }}"

          if [ "$ESA_REFRESH_STATUS" = "success" ]; then
            ESA_REFRESH_EMOJI="âœ…"
            ESA_REFRESH_TEXT="æˆåŠŸ"
          else
            ESA_REFRESH_EMOJI="âŒ"
            ESA_REFRESH_TEXT="å¤±è´¥"
          fi

          if [ "$ESA_PREHEAT_STATUS" = "success" ]; then
            ESA_PREHEAT_EMOJI="âœ…"
            ESA_PREHEAT_TEXT="æˆåŠŸ"
          else
            ESA_PREHEAT_EMOJI="âŒ"
            ESA_PREHEAT_TEXT="å¤±è´¥"
          fi

          FILE_COUNT="${{ steps.file-list.outputs.file_count }}"

          curl -X POST -H "Content-Type: application/json" \
          -d '{
            "msg_type": "post",
            "content": {
              "post": {
                "zh_cn": {
                  "title": "ğŸ“¦ ${{ github.repository }} æ–‡æ¡£éƒ¨ç½²æˆåŠŸ",
                  "content": [
                    [{
                      "tag": "text",
                      "text": "ğŸ”€ åˆ†æ”¯: ${{ github.ref_name }}"
                    }],
                    [{
                      "tag": "text",
                      "text": "ğŸ“ æäº¤: ${{ github.sha }}"
                    }],
                    [{
                      "tag": "text",
                      "text": "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
                    }],
                    [{
                      "tag": "text",
                      "text": "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    }],
                    [{
                      "tag": "text",
                      "text": "âœ… ä»£ç æ£€å‡º: æˆåŠŸ"
                    }],
                    [{
                      "tag": "text",
                      "text": "âœ… ä¾èµ–å®‰è£…: æˆåŠŸ"
                    }],
                    [{
                      "tag": "text",
                      "text": "âœ… é¡¹ç›®æ„å»º: æˆåŠŸ ('"$FILE_COUNT"' ä¸ªæ–‡ä»¶)"
                    }],
                    [{
                      "tag": "text",
                      "text": "âœ… Docker Hub ç™»å½•: æˆåŠŸ"
                    }],
                    [{
                      "tag": "text",
                      "text": "âœ… é˜¿é‡Œäº‘é•œåƒä»“åº“ç™»å½•: æˆåŠŸ"
                    }],
                    [{
                      "tag": "text",
                      "text": "âœ… Docker é•œåƒæ„å»ºæ¨é€: æˆåŠŸ"
                    }],
                    [{
                      "tag": "text",
                      "text": "âœ… è§¦å‘éƒ¨ç½² Webhook: æˆåŠŸ"
                    }],
                    [{
                      "tag": "text",
                      "text": "'"$ESA_REFRESH_EMOJI"' åˆ·æ–° ESA ç¼“å­˜: '"$ESA_REFRESH_TEXT"'"
                    }],
                    [{
                      "tag": "text",
                      "text": "'"$ESA_PREHEAT_EMOJI"' ESA ç¼“å­˜é¢„çƒ­: '"$ESA_PREHEAT_TEXT"'"
                    }],
                    [{
                      "tag": "text",
                      "text": "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    }],
                    [{
                      "tag": "text",
                      "text": "ğŸ³ é•œåƒåœ°å€: registry.cn-hangzhou.aliyuncs.com/passnat/docs:${{ github.sha }}"
                    }],
                    [{
                      "tag": "at",
                      "user_id": "all"
                    }]
                  ]
                }
              }
            }
          }' \
          ${{ secrets.FEISHU_WEBHOOK_URL }}

      - name: Send Failure Notification to Feishu
        if: failure()
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{
            "msg_type": "post",
            "content": {
              "post": {
                "zh_cn": {
                  "title": "ğŸš¨ ${{ github.repository }} æ–‡æ¡£éƒ¨ç½²å¤±è´¥",
                  "content": [
                    [{
                      "tag": "text",
                      "text": "ğŸ”€ åˆ†æ”¯: ${{ github.ref_name }}"
                    }],
                    [{
                      "tag": "text",
                      "text": "ğŸ“ æäº¤: ${{ github.sha }}"
                    }],
                    [{
                      "tag": "text",
                      "text": "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
                    }],
                    [{
                      "tag": "text",
                      "text": "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    }],
                    [{
                      "tag": "text",
                      "text": "ğŸ”— æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }],
                    [{
                      "tag": "at",
                      "user_id": "all"
                    }]
                  ]
                }
              }
            }
          }' \
          ${{ secrets.FEISHU_WEBHOOK_URL }}
